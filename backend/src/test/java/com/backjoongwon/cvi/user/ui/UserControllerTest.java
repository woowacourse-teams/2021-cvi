package com.backjoongwon.cvi.user.ui;


import com.backjoongwon.cvi.ApiDocument;
import com.backjoongwon.cvi.auth.domain.authorization.SocialProvider;
import com.backjoongwon.cvi.comment.domain.Comment;
import com.backjoongwon.cvi.comment.dto.CommentResponse;
import com.backjoongwon.cvi.common.exception.InvalidInputException;
import com.backjoongwon.cvi.common.exception.NotFoundException;
import com.backjoongwon.cvi.common.exception.UnAuthorizedException;
import com.backjoongwon.cvi.post.application.PostService;
import com.backjoongwon.cvi.post.domain.Filter;
import com.backjoongwon.cvi.post.domain.VaccinationType;
import com.backjoongwon.cvi.post.dto.PostWithCommentResponse;
import com.backjoongwon.cvi.user.application.UserService;
import com.backjoongwon.cvi.user.domain.AgeRange;
import com.backjoongwon.cvi.user.domain.JwtTokenProvider;
import com.backjoongwon.cvi.user.domain.User;
import com.backjoongwon.cvi.user.dto.UserRequest;
import com.backjoongwon.cvi.user.dto.UserResponse;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.ResultActions;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedList;
import java.util.List;
import java.util.stream.Stream;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.BDDMockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@DisplayName("ì‚¬ìš©ì ì»¨íŠ¸ë¡¤ëŸ¬ Mock í…ŒìŠ¤íŠ¸")
@WebMvcTest(controllers = UserController.class)
class UserControllerTest extends ApiDocument {

    private static final String ACCESS_TOKEN = "{ACCESS TOKEN generated by JWT}";
    private static final String BEARER = "Bearer ";
    private static final String NICKNAME = "ì¸ë¹„";
    private static final AgeRange AGE_RANGE = AgeRange.TWENTIES;
    private static final String PROFILE_URL = "kakao.com/profile";
    private static final SocialProvider SOCIAL_PROVIDER = SocialProvider.KAKAO;
    private static final String SOCIAL_ID = "{Unique ID received from social provider}";
    private static final Long USER_ID = 1L;
    private static final Long POST_ID = 1L;
    private static final Long COMMENT_ID = 1L;

    @MockBean
    private UserService userService;

    @MockBean
    private PostService postService;

    @MockBean
    private JwtTokenProvider jwtTokenProvider;

    private User user;
    private UserRequest signinRequest;
    private UserRequest updateRequest;
    private UserResponse userResponse;
    private UserResponse userMeResponse;
    private List<CommentResponse> commentResponses;

    @BeforeEach
    void beforeEach() {
        user = User.builder()
                .id(USER_ID)
                .nickname(NICKNAME)
                .ageRange(AgeRange.TWENTIES)
                .socialProvider(SOCIAL_PROVIDER)
                .socialId(SOCIAL_ID)
                .profileUrl(PROFILE_URL)
                .build();

        signinRequest = new UserRequest(NICKNAME, AGE_RANGE, false, SOCIAL_PROVIDER, SOCIAL_ID, PROFILE_URL);
        updateRequest = new UserRequest(NICKNAME, AGE_RANGE, true, SOCIAL_PROVIDER, SOCIAL_ID, PROFILE_URL);
        userResponse = UserResponse.of(user, ACCESS_TOKEN);
        userMeResponse = UserResponse.of(user, null);

        Comment comment1 = Comment.builder().id(COMMENT_ID).content("ëŒ“ê¸€1").user(user).createdAt(LocalDateTime.now()).build();
        Comment comment2 = Comment.builder().id(COMMENT_ID + 1).content("ëŒ“ê¸€2").user(user).createdAt(LocalDateTime.now()).build();

        commentResponses = Arrays.asList(CommentResponse.of(comment1), CommentResponse.of(comment2));

        given(jwtTokenProvider.isValidToken(ACCESS_TOKEN)).willReturn(true);
        given(jwtTokenProvider.getPayload(ACCESS_TOKEN)).willReturn(String.valueOf(user.getId()));
        given(userService.findUserById(any(Long.class))).willReturn(user);
    }

    @DisplayName("ì‚¬ìš©ì ê°€ì… - ì„±ê³µ")
    @Test
    void signup() throws Exception {
        //given
        willReturn(userResponse).given(userService).signup(any(UserRequest.class));
        //when
        ResultActions response = ì‚¬ìš©ì_íšŒì›ê°€ì…_ìš”ì²­(signinRequest);
        //then
        ì‚¬ìš©ì_íšŒì›ê°€ì…_ì„±ê³µí•¨(response, userResponse);
    }

    @DisplayName("ì‚¬ìš©ì ê°€ì… - ì‹¤íŒ¨")
    @Test
    void signupFailure() throws Exception {
        //given
        willThrow(new InvalidInputException("ì¤‘ë³µëœ ë‹‰ë„¤ì„ì´ ì¡´ì¬í•©ë‹ˆë‹¤.")).given(userService).signup(any(UserRequest.class));
        //when
        ResultActions response = ì‚¬ìš©ì_íšŒì›ê°€ì…_ìš”ì²­(signinRequest);
        //then
        ì‚¬ìš©ì_íšŒì›ê°€ì…_ì‹¤íŒ¨í•¨(response);
    }

    @DisplayName("ì‚¬ìš©ì ë‚´ ì •ë³´ ì¡°íšŒ - ì„±ê³µ")
    @Test
    void findMe() throws Exception {
        //given
        willReturn(userMeResponse).given(userService).findUser(any());
        //when
        ResultActions response = ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ìš”ì²­();
        //then
        ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ì„±ê³µí•¨(response, userMeResponse);
    }

    @DisplayName("ì‚¬ìš©ì ë‚´ ì •ë³´ ì¡°íšŒ - ì‹¤íŒ¨")
    @Test
    void findMeFailure() throws Exception {
        //given
        willThrow(new UnAuthorizedException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.")).given(userService).findUser(any());
        //when
        ResultActions response = ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ìš”ì²­();
        //then
        ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ì‹¤íŒ¨í•¨(response);
    }

    @DisplayName("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ - ì„±ê³µ")
    @Test
    void find() throws Exception {
        //given
        User otherUser = User.builder()
                .id(1L)
                .nickname(NICKNAME)
                .ageRange(AgeRange.TWENTIES)
                .socialProvider(SOCIAL_PROVIDER)
                .profileUrl(PROFILE_URL)
                .build();
        UserResponse userResponseWithoutPrivacy = UserResponse.of(otherUser, null);
        willReturn(userResponseWithoutPrivacy).given(userService).findById(any(Long.class));
        //when
        ResultActions response = ì‚¬ìš©ì_ì¡°íšŒ_ìš”ì²­(userResponseWithoutPrivacy.getId());
        //then
        ì‚¬ìš©ì_ì¡°íšŒ_ì„±ê³µí•¨(response, userResponseWithoutPrivacy);
    }

    @DisplayName("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ - ì‹¤íŒ¨")
    @Test
    void findFailure() throws Exception {
        //given
        willThrow(new NotFoundException("í•´ë‹¹ idì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")).given(userService).findById(any(Long.class));
        //when
        ResultActions response = ì‚¬ìš©ì_ì¡°íšŒ_ìš”ì²­(userResponse.getId());
        //then
        ì‚¬ìš©ì_ì¡°íšŒ_ì‹¤íŒ¨í•¨(response);
    }

    @DisplayName("ì‚¬ìš©ì ì—…ë°ì´íŠ¸ -  ì„±ê³µ")
    @Test
    void update() throws Exception {
        //given
        willDoNothing().given(userService).update(any(), any(UserRequest.class));
        //when
        ResultActions response = ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ìš”ì²­(updateRequest);
        //then
        ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ì„±ê³µ(response);
    }

    @DisplayName("ì‚¬ìš©ì ì—…ë°ì´íŠ¸ -  ì‹¤íŒ¨")
    @Test
    void updateFailure() throws Exception {
        //given
        willThrow(new InvalidInputException("ì¤‘ë³µëœ ë‹‰ë„¤ì„ì´ ì¡´ì¬í•©ë‹ˆë‹¤."))
                .given(userService).update(any(), any(UserRequest.class));
        //when
        ResultActions response = ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ìš”ì²­(updateRequest);
        //then
        ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ì‹¤íŒ¨í•¨(response);
    }

    @DisplayName("ì‚¬ìš©ì ì‚­ì œ -  ì„±ê³µ")
    @Test
    void deleteUser() throws Exception {
        //given
        willDoNothing().given(userService).delete(any());
        //when
        ResultActions response = ì‚¬ìš©ì_ì‚­ì œ_ìš”ì²­();
        //then
        ì‚¬ìš©ì_ì‚­ì œ_ì„±ê³µ(response);
    }

    @DisplayName("ì‚¬ìš©ì ì‚­ì œ -  ì‹¤íŒ¨")
    @Test
    void deleteFailure() throws Exception {
        //given
        willThrow(new NotFoundException("í•´ë‹¹ idì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")).given(userService).delete(any());
        //when
        ResultActions response = ì‚¬ìš©ì_ì‚­ì œ_ìš”ì²­();
        //then
        ì‚¬ìš©ì_ì‚­ì œ_ì‹¤íŒ¨(response);
    }

    @DisplayName("ë‚´ê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ ì¡°íšŒ - ì„±ê³µ")
    @Test
    void findMyPostsWhenFilterIsNone() throws Exception {
        //given
        List<PostWithCommentResponse> postWithCommentResponse = Arrays.asList(
                new PostWithCommentResponse(POST_ID, userResponse, "ê¸€ ë‚´ìš©1", 55, 5, true, commentResponses, VaccinationType.PFIZER, LocalDateTime.now().minusDays(1L)),
                new PostWithCommentResponse(POST_ID + 1, userResponse, "ê¸€ ë‚´ìš©2", 12, 0, false, Collections.emptyList(), VaccinationType.MODERNA, LocalDateTime.now()),
                new PostWithCommentResponse(POST_ID + 2, userResponse, "ê¸€ ë‚´ìš©3", 12, 0, false, Collections.emptyList(), VaccinationType.ASTRAZENECA, LocalDateTime.now()));
        Filter filter = Filter.NONE;
        willReturn(postWithCommentResponse).given(postService).findByUserAndFilter(any(), any(Filter.class));
        //when
        ResultActions response = ë‚´ê°€_ì“´_ê¸€_ì¡°íšŒ_ìš”ì²­();
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(response, postWithCommentResponse, filter);
    }

    @DisplayName("ë‚´ê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ ì¡°íšŒ - ì‹¤íŒ¨")
    @Test
    void findMyPostsFailureWhenFilterIsNone() throws Exception {
        //given
        Filter filter = Filter.NONE;
        willThrow(new UnAuthorizedException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")).given(postService).findByUserAndFilter(any(), any(Filter.class));
        //when
        ResultActions response = ë‚´ê°€_ì“´_ê¸€_ì¡°íšŒ_ìš”ì²­();
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(response, filter);
    }

    @DisplayName("ë‚´ê°€ ì¢‹ì•„ìš” í•œ ê¸€ ì¡°íšŒ - ì„±ê³µ")
    @Test
    void findMyPostsWhenFilterIsLikes() throws Exception {
        //given
        List<PostWithCommentResponse> postWithCommentResponse = Arrays.asList(
                new PostWithCommentResponse(POST_ID, userResponse, "ê¸€ ë‚´ìš©1", 55, 5, true, commentResponses, VaccinationType.PFIZER, LocalDateTime.now().minusDays(1L)),
                new PostWithCommentResponse(POST_ID + 1, userResponse, "ê¸€ ë‚´ìš©2", 12, 0, true, Collections.emptyList(), VaccinationType.MODERNA, LocalDateTime.now()));
        Filter filter = Filter.LIKES;
        willReturn(postWithCommentResponse).given(postService).findByUserAndFilter(any(), any(Filter.class));
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­(filter);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(response, postWithCommentResponse, filter);
    }

    @DisplayName("ë‚´ê°€ ì¢‹ì•„ìš” í•œ ê¸€ ì¡°íšŒ - ì‹¤íŒ¨")
    @Test
    void findMyPostsFailureWhenFilterIsLikes() throws Exception {
        //given
        Filter filter = Filter.LIKES;
        willThrow(new UnAuthorizedException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")).given(postService).findByUserAndFilter(any(), any(Filter.class));
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­(filter);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(response, filter);
    }

    @DisplayName("ë‚´ê°€ ëŒ“ê¸€ì„ ë‹¨ ê²Œì‹œê¸€ ì¡°íšŒ - ì„±ê³µ")
    @Test
    void findMyPostsWhenFilterIsComments() throws Exception {
        //given
        List<PostWithCommentResponse> postWithCommentResponse = Arrays.asList(
                new PostWithCommentResponse(POST_ID, userResponse, "ê¸€ ë‚´ìš©1", 55, 5, true, commentResponses, VaccinationType.PFIZER, LocalDateTime.now().minusDays(1L)),
                new PostWithCommentResponse(POST_ID + 1, userResponse, "ê¸€ ë‚´ìš©2", 12, 0, false, commentResponses, VaccinationType.MODERNA, LocalDateTime.now()));
        Filter filter = Filter.COMMENTS;
        willReturn(postWithCommentResponse).given(postService).findByUserAndFilter(any(), any(Filter.class));
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­(filter);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(response, postWithCommentResponse, filter);
    }

    @DisplayName("ë‚´ê°€ ëŒ“ê¸€ì„ ë‹¨ ê²Œì‹œê¸€ ì¡°íšŒ - ì‹¤íŒ¨")
    @Test
    void findMyPostsFailureWhenFilterIsComments() throws Exception {
        //given
        Filter filter = Filter.COMMENTS;
        willThrow(new UnAuthorizedException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")).given(postService).findByUserAndFilter(any(), any(Filter.class));
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­(filter);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(response, filter);
    }

    @DisplayName("ë‚´ê°€ ì‘ì„±í•œ ê¸€ ì¡°íšŒ í˜ì´ì§• - ì„±ê³µ")
    @Test
    void findMyPostsWhenFilterIsNonePaging() throws Exception {
        //given
        List<PostWithCommentResponse> postWithCommentResponse = new LinkedList<>(Arrays.asList(
                new PostWithCommentResponse(38L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.", 100, 10, false, commentResponses, VaccinationType.PFIZER, LocalDateTime.now()),
                new PostWithCommentResponse(37L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.2", 200, 20, true, Collections.emptyList(), VaccinationType.MODERNA, LocalDateTime.now().minusDays(1L)),
                new PostWithCommentResponse(36L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.3", 300, 30, false, Collections.emptyList(), VaccinationType.ASTRAZENECA, LocalDateTime.now().minusHours(2L)),
                new PostWithCommentResponse(35L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.3", 300, 30, false, Collections.emptyList(), VaccinationType.ASTRAZENECA, LocalDateTime.now().minusHours(2L))
        ));
        Filter filter = Filter.NONE;
        willReturn(postWithCommentResponse).given(postService).findByUserAndFilter(any(Filter.class), any(Integer.class), anyInt(), any());
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(filter, 0, 4);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(response, postWithCommentResponse, filter);
    }

    @DisplayName("ë‚´ê°€ ì‘ì„±í•œ ê¸€ ì¡°íšŒ í˜ì´ì§• - ì‹¤íŒ¨")
    @Test
    void findMyPostsFailureWhenFilterIsNonePaging() throws Exception {
        //given
        Filter filter = Filter.NONE;
        willThrow(new UnAuthorizedException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")).given(postService).findByUserAndFilter(any(Filter.class), any(Integer.class), anyInt(), any());
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(filter, 0, 4);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(response, filter);
    }

    @DisplayName("ë‚´ê°€ ì¢‹ì•„ìš” í•œ ê¸€ ì¡°íšŒ í˜ì´ì§• - ì„±ê³µ")
    @Test
    void findMyPostsWhenFilterIsLikesPaging() throws Exception {
        //given
        List<PostWithCommentResponse> postWithCommentResponse = new LinkedList<>(Arrays.asList(
                new PostWithCommentResponse(38L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.", 100, 10, true, commentResponses, VaccinationType.PFIZER, LocalDateTime.now()),
                new PostWithCommentResponse(37L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.2", 200, 20, true, Collections.emptyList(), VaccinationType.MODERNA, LocalDateTime.now().minusDays(1L)),
                new PostWithCommentResponse(36L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.3", 300, 30, true, Collections.emptyList(), VaccinationType.ASTRAZENECA, LocalDateTime.now().minusHours(2L))
        ));
        Filter filter = Filter.LIKES;
        willReturn(postWithCommentResponse).given(postService).findByUserAndFilter(any(Filter.class), anyInt(), anyInt(), any());
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(filter, 0, 3);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(response, postWithCommentResponse, filter);
    }

    @DisplayName("ë‚´ê°€ ì¢‹ì•„ìš” í•œ ê¸€ ì¡°íšŒ í˜ì´ì§• - ì‹¤íŒ¨")
    @Test
    void findMyPostsFailureWhenFilterIsLikesPaging() throws Exception {
        //given
        Filter filter = Filter.LIKES;
        willThrow(new UnAuthorizedException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")).given(postService).findByUserAndFilter(any(Filter.class), anyInt(), anyInt(), any());
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(filter, 0, 3);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(response, filter);
    }

    @DisplayName("ë‚´ê°€ ëŒ“ê¸€ì„ ë‹¨ ê¸€ ì¡°íšŒ í˜ì´ì§• - ì„±ê³µ")
    @Test
    void findMyPostsWhenFilterIsCommentsPaging() throws Exception {
        //given
        List<PostWithCommentResponse> postWithCommentResponse = new LinkedList<>(Arrays.asList(
                new PostWithCommentResponse(38L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.", 100, 10, false, commentResponses, VaccinationType.PFIZER, LocalDateTime.now()),
                new PostWithCommentResponse(37L, userResponse, "ì´ê±´ ë‚´ìš©ì…ë‹ˆë‹¤.2", 200, 20, false, commentResponses, VaccinationType.MODERNA, LocalDateTime.now().minusDays(1L))
        ));
        Filter filter = Filter.COMMENTS;
        willReturn(postWithCommentResponse).given(postService).findByUserAndFilter(any(Filter.class), anyInt(), anyInt(), any());
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(filter, 0, 2);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(response, postWithCommentResponse, filter);
    }

    @DisplayName("ë‚´ê°€ ëŒ“ê¸€ì„ ë‹¨ ê¸€ ì¡°íšŒ í˜ì´ì§• - ì‹¤íŒ¨")
    @Test
    void findMyPostsFailureWhenFilterIsCommentsPaging() throws Exception {
        //given
        Filter filter = Filter.COMMENTS;
        willThrow(new UnAuthorizedException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")).given(postService).findByUserAndFilter(any(Filter.class), anyInt(), anyInt(), any());
        //when
        ResultActions response = ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(filter, 0, 3);
        //then
        ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(response, filter);
    }

    @ParameterizedTest(name = "UserRequest validation - ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° - ë‹‰ë„¤ì„")
    @MethodSource
    void validateUserRequestWhenInvalidNickName(UserRequest userRequest) throws Exception {
        //given
        //when
        ResultActions createResponse = ì‚¬ìš©ì_íšŒì›ê°€ì…_ìš”ì²­(userRequest);
        ResultActions updateResponse = ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ìš”ì²­(userRequest);
        //then
        assertThat(createResponse.andReturn().getResponse().getStatus()).isEqualTo(HttpStatus.BAD_REQUEST.value());
        assertThat(updateResponse.andReturn().getResponse().getStatus()).isEqualTo(HttpStatus.BAD_REQUEST.value());
    }

    static Stream<Arguments> validateUserRequestWhenInvalidNickName() {
        return Stream.of(
                Arguments.of(new UserRequest(" ", AgeRange.TEENS, false, SocialProvider.NAVER, SOCIAL_ID, PROFILE_URL)),
                Arguments.of(new UserRequest("123456789012345678901", AgeRange.TEENS, false, SocialProvider.NAVER, SOCIAL_ID, PROFILE_URL)),
                Arguments.of(new UserRequest("!@#$%^", AgeRange.TEENS, false, SocialProvider.NAVER, SOCIAL_ID, PROFILE_URL)),
                Arguments.of(new UserRequest("ğŸ‘", AgeRange.TEENS, false, SocialProvider.NAVER, SOCIAL_ID, PROFILE_URL)));
    }

    @ParameterizedTest(name = "UserRequest validation - ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° - ê·¸ ì™¸")
    @MethodSource
    void validateUserRequest(UserRequest userRequest) throws Exception {
        //given
        //when
        ResultActions createResponse = ì‚¬ìš©ì_íšŒì›ê°€ì…_ìš”ì²­(userRequest);
        ResultActions updateResponse = ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ìš”ì²­(userRequest);
        //then
        assertThat(createResponse.andReturn().getResponse().getStatus()).isEqualTo(HttpStatus.BAD_REQUEST.value());
        assertThat(updateResponse.andReturn().getResponse().getStatus()).isEqualTo(HttpStatus.BAD_REQUEST.value());
    }

    static Stream<Arguments> validateUserRequest() {
        return Stream.of(
                Arguments.of(new UserRequest(NICKNAME, null, false, SocialProvider.NAVER, SOCIAL_ID, PROFILE_URL)),
                Arguments.of(new UserRequest(NICKNAME, AgeRange.TEENS, false, null, SOCIAL_ID, PROFILE_URL)),
                Arguments.of(new UserRequest(NICKNAME, AgeRange.TEENS, false, SocialProvider.NAVER, "  ", PROFILE_URL)),
                Arguments.of(new UserRequest(NICKNAME, AgeRange.TEENS, false, SocialProvider.NAVER, SOCIAL_ID, " ")));
    }

    private ResultActions ì‚¬ìš©ì_íšŒì›ê°€ì…_ìš”ì²­(UserRequest request) throws Exception {
        return mockMvc.perform(post("/api/v1/users/signup")
                .contentType(MediaType.APPLICATION_JSON)
                .content(toJson(request)));
    }

    private void ì‚¬ìš©ì_íšŒì›ê°€ì…_ì„±ê³µí•¨(ResultActions response, UserResponse userResponse) throws Exception {
        response.andExpect(status().isCreated())
                .andExpect(header().string("Location", "/api/v1/users/" + userResponse.getId()))
                .andExpect(content().json(toJson(userResponse)))
                .andDo(print())
                .andDo(toDocument("user-signup"));
    }

    private void ì‚¬ìš©ì_íšŒì›ê°€ì…_ì‹¤íŒ¨í•¨(ResultActions response) throws Exception {
        response.andExpect(status().isBadRequest())
                .andDo(print())
                .andDo(toDocument("user-signup-failure"));
    }

    private ResultActions ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ìš”ì²­() throws Exception {
        return mockMvc.perform(get("/api/v1/users/me")
                .header(HttpHeaders.AUTHORIZATION, BEARER + ACCESS_TOKEN));
    }

    private void ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ì„±ê³µí•¨(ResultActions response, UserResponse userResponse) throws Exception {
        response.andExpect(status().isOk())
                .andExpect(content().json(toJson(userResponse)))
                .andDo(print())
                .andDo(toDocument("user-find-me"));
    }

    private void ì‚¬ìš©ì_ë‚´_ì •ë³´_ì¡°íšŒ_ì‹¤íŒ¨í•¨(ResultActions response) throws Exception {
        response.andExpect(status().isUnauthorized())
                .andDo(print())
                .andDo(toDocument("user-find-me-failure"));
    }

    private ResultActions ì‚¬ìš©ì_ì¡°íšŒ_ìš”ì²­(Long id) throws Exception {
        return mockMvc.perform(get("/api/v1/users/" + id)
                .contentType(MediaType.APPLICATION_JSON));
    }

    private void ì‚¬ìš©ì_ì¡°íšŒ_ì„±ê³µí•¨(ResultActions response, UserResponse userResponse) throws Exception {
        response.andExpect(status().isOk())
                .andExpect(content().json(toJson(userResponse)))
                .andDo(print())
                .andDo(toDocument("user-find"));
    }

    private void ì‚¬ìš©ì_ì¡°íšŒ_ì‹¤íŒ¨í•¨(ResultActions response) throws Exception {
        response.andExpect(status().isNotFound())
                .andDo(print())
                .andDo(toDocument("user-find-failure"));
    }

    private ResultActions ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ìš”ì²­(UserRequest request) throws Exception {
        return mockMvc.perform(put("/api/v1/users/me")
                .contentType(MediaType.APPLICATION_JSON)
                .content(toJson(request))
                .header(HttpHeaders.AUTHORIZATION, BEARER + ACCESS_TOKEN));
    }

    private void ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ì„±ê³µ(ResultActions response) throws Exception {
        response.andExpect(status().isNoContent())
                .andDo(print())
                .andDo(toDocument("user-update"));
    }

    private void ì‚¬ìš©ì_ì—…ë°ì´íŠ¸_ì‹¤íŒ¨í•¨(ResultActions response) throws Exception {
        response.andExpect(status().isBadRequest())
                .andDo(print())
                .andDo(toDocument("user-update-failure"));
    }

    private ResultActions ì‚¬ìš©ì_ì‚­ì œ_ìš”ì²­() throws Exception {
        return mockMvc.perform(delete("/api/v1/users")
                .header(HttpHeaders.AUTHORIZATION, BEARER + ACCESS_TOKEN));
    }

    private void ì‚¬ìš©ì_ì‚­ì œ_ì„±ê³µ(ResultActions response) throws Exception {
        response.andExpect(status().isNoContent())
                .andDo(print())
                .andDo(toDocument("user-delete"));
    }

    private void ì‚¬ìš©ì_ì‚­ì œ_ì‹¤íŒ¨(ResultActions response) throws Exception {
        response.andExpect(status().isNotFound())
                .andDo(print())
                .andDo(toDocument("user-delete-failure"));
    }

    private ResultActions ë‚´ê°€_ì“´_ê¸€_ì¡°íšŒ_ìš”ì²­() throws Exception {
        return mockMvc.perform(get("/api/v1/users/me/posts")
                .contentType(MediaType.APPLICATION_JSON)
                .header(HttpHeaders.AUTHORIZATION, BEARER + ACCESS_TOKEN));
    }

    private ResultActions ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­(Filter filter) throws Exception {
        return mockMvc.perform(get("/api/v1/users/me/posts")
                .contentType(MediaType.APPLICATION_JSON)
                .header(HttpHeaders.AUTHORIZATION, BEARER + ACCESS_TOKEN)
                .queryParam("filter", filter.name()));
    }

    private ResultActions ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­(Filter filter, int offset, int size) throws Exception {
        return mockMvc.perform(get("/api/v1/users/me/posts/paging")
                .queryParam("filter", filter.name())
                .queryParam("offset", String.valueOf(offset))
                .queryParam("size", String.valueOf(size))
                .header(HttpHeaders.AUTHORIZATION, BEARER + ACCESS_TOKEN));
    }

    private void ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(ResultActions response, List<PostWithCommentResponse> postWithCommentResponse, Filter filter) throws Exception {
        response.andExpect(status().isOk())
                .andExpect(content().json(toJson(postWithCommentResponse)))
                .andDo(print())
                .andDo(toDocument("user-me-posts-paging-" + filter.name().toLowerCase()));
    }

    private void ë§ˆì´í˜ì´ì§€_ê¸€_íƒ€ì…ë³„_í˜ì´ì§•_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(ResultActions response, Filter filter) throws Exception {
        response.andExpect(status().isUnauthorized())
                .andDo(print())
                .andDo(toDocument("user-me-posts-paging-" + filter.name().toLowerCase() + "-failure"));
    }

    private void ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì„±ê³µí•¨(ResultActions response, List<PostWithCommentResponse> postWithCommentResponse, Filter filter) throws Exception {
        response.andExpect(status().isOk())
                .andExpect(content().json(toJson(postWithCommentResponse)))
                .andDo(print())
                .andDo(toDocument("user-me-posts-filter-" + filter.name().toLowerCase()));
    }

    private void ë§ˆì´í˜ì´ì§€_ê¸€_í•„í„°ë§_ì¡°íšŒ_ìš”ì²­_ì‹¤íŒ¨í•¨(ResultActions response, Filter filter) throws Exception {
        response.andExpect(status().isUnauthorized())
                .andDo(print())
                .andDo(toDocument("user-me-posts-filter-" + filter.name().toLowerCase() + "-failure"));
    }
}
